---
title: "dev_species_block_map"
author: "N.M. Tarr"
date: "2023-09-12"
output: html_document
---

```{r setup, include=TRUE, message=TRUE, warning=TRUE}
setwd("~/Code/NCBA/resources")
source("ncba_functions.R")

knitr::opts_knit$set(root.dir = work_dir)
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)
```

# IN PROGRESS

# Purpose
This document defines and demonstrates a function that supports the following data contract task:

"Map of blocks where the species has been predicted to occur, but has not yet been reported, including highest coded observation per species in block and distinguished by breeding/non-breeding season based on best available safe dates, GAP predictions, or other appropriate metrics."

# Function

```{r}
fields <- c("ID_BLOCK_CODE", "ID_EBD_NAME")
blocks_sf <- get_blocks(spatial = TRUE, fields = fields)
```


```{r}
season <- "summer" # SUMMER, WINTER or BREEDING, WINTERING
species <- "Red-breasted Nuthatch"
source <- "GAP" # "eBird"
```


```{r}
get_predicted_presence <- function(species, source, season) { 
  # Returns a dataframe of blocks where the species was predicted to occur.
  #
  # Description:
  # The AtlasCache blocks document contains fields that report species lists 
  #   for each block in summer and winter.  Those lists are derived from 
  #   predictions by the USGS GAP Analysis Program and eBird.  This function
  #   retrieves a dataframe of blocks that were predicted to be occupied by a
  #   species of interested, during a season of interest, and from a source
  #   of interest.
  #
  # Parameters:
  # species -- the common name of the species of interest.
  # source -- who's prediction you want: "GAP" or "eBird"
  # season -- "summer" or "winter" for GAP; "breeding" or "wintering" for eBird
  
  season <- str_to_upper(season)
  source_lookup <- list("GAP" = "GAP_SPP", "eBird" = "EBD_SPP")
  source <- source_lookup[[source]]
  
  # Connect to the blocks collection (table)
  connection_blocks <- connect_ncba_db(database = "ebd_mgmt", 
                                       collection = "blocks")
  
  # Define and execute a query (with fields) for blocks of predicted presence.
  fields <- '{"ID_EBD_NAME": true}'
  query <- str_interp('{"${source}.PRIMARY_COM_NAME": "${species}", "${source}.${season}": 1}')
  pres <- connection_blocks$find(fields = fields, query = query)
  
  # Add a presence column for the source
  pres$present <- TRUE
  new_name <- paste0(source, "_", season)
  rename(pres, !!new_name:= present)
  
  return(pres)
}
```


```{r}
# GAP summer
GAP.summer <- get_predicted_presence(species = species, source = "GAP",
                                     season = "summer")
GAP.summer <- right_join(blocks_sf, GAP.summer)

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = GAP.summer, aes(fill = 'blue')) + 
  ggtitle("GAP Summer Range")
```


```{r}
# eBird summer
EBD.summer <- get_predicted_presence(species = species, source = "eBird",
                                     season = "breeding")
EBD.summer <- right_join(blocks_sf, EBD.summer) 

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = EBD.summer, aes(fill = 'blue')) +
  ggtitle("eBird Summer Range")
```

```{r}
# GAP winter
GAP.winter <- get_predicted_presence(species = species, source = "GAP",
                                     season = "winter")
GAP.winter <- right_join(blocks_sf, GAP.winter)

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = GAP.winter, aes(fill = 'blue')) +
  ggtitle("GAP Winter Range")
```

```{r}
# eBird wintering
eBird.wintering <- get_predicted_presence(species = species, source = "eBird",
                                     season = "wintering")
eBird.wintering <- right_join(blocks_sf, eBird.wintering)

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = eBird.wintering, aes(fill = 'blue')) +
  ggtitle("eBird Winter Range")
```

```{r}
fields <- c("atlas_block", "observation_count")

# # Get all the observations for the species
# obs <- get_observations(species = species, database = "AtlasCache", 
#                         NCBA_only = TRUE, fields = NULL) %>%
#   to_EBD_format() %>%
#   filter(observation_count != 0)

# Pull out the blocks with observations
pres.blocks <- obs %>%
  select(fields) %>%
  distinct()
```


```{r}
pres.blocks_sf <- right_join(blocks_sf, pres.blocks, by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = pres.blocks_sf, aes(fill = "blue")) +
  ggtitle("Blocks With Observations")
  


blocks_observed_in <- function(what_weeks, breeding_categories) 
  {
  # Returns a dataframe of blocks where the species was observed.
  #
  # Description:
  # 
  #
  # Parameters:
  # species -- the common name of the species of interest.
  # source -- who's prediction you want: "GAP" or "eBird"
  # which_weeks -- 
  # breeding_categories -- 
  df <- NULL

  
  return(df)
}
```

```{r}
# Pull out breeding season records
breedates <- breeding_dates(species, basis = c("confirmed", "probable"),
                            quantiles = c(0.1, 0.9), year = 2023,
                            year_day = TRUE)

statewide_breedates <- breedates[["statewide"]]
```

```{r}
nonbreeding.obs <- obs %>%
  filter(yday(observation_date) < statewide_breedates[[1]] | yday(observation_date) > statewide_breedates[[2]])

nonbreeding_sf <- right_join(blocks_sf, nonbreeding.obs, 
                   by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = GAP.winter, aes(fill = present)) +
  geom_sf(data = nonbreeding_sf, aes(fill = common_name)) +
  ggtitle("GAP Winter Range and Winter NCBA Observations")
```


```{r}
breeding.obs <- obs %>%
  filter(yday(observation_date) > statewide_breedates[[1]] & yday(observation_date) < statewide_breedates[[2]])

breeding_sf <- right_join(blocks_sf, breeding.obs, 
                   by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = breeding_sf, aes(fill = common_name)) +
  ggtitle("Breeding Season Observations")
```


```{r}
# Confirmed
confirmed <- obs %>%
  filter(yday(observation_date) > statewide_breedates[[1]] & yday(observation_date) < statewide_breedates[[2]]) %>%
  filter(breeding_category == "C4")

confirmed_sf <- right_join(blocks_sf, confirmed, 
                   by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = confirmed_sf, aes(fill = common_name)) +
  ggtitle("Blocks with Confirmed Breeding")
```

```{r}
# Probable
probable <- obs %>%
  filter(yday(observation_date) > statewide_breedates[[1]] & yday(observation_date) < statewide_breedates[[2]]) %>%
  filter(breeding_category == "C3")

probable_sf <- right_join(blocks_sf, probable, 
                   by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = probable_sf, aes(fill = common_name)) +
  ggtitle("Blocks with Probable Breeding")
```

```{r}
# Possible
possible <- obs %>%
  filter(yday(observation_date) > statewide_breedates[[1]] & yday(observation_date) < statewide_breedates[[2]]) %>%
  filter(breeding_category == "C2")

possible_sf <- right_join(blocks_sf, possible, 
                   by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = possible_sf, aes(fill = common_name)) +
  ggtitle("Blocks with Possible Breeding")
```


```{r}
# FIND THE HIGHEST CODE PER BLOCK
obs$breeding_category <- factor(obs$breeding_categor, 
                                levels = c("C4", "C3", "C2", "C1"))


# start with obs
highest <- obs %>%
  filter(is.na(breeding_category) == FALSE, breeding_category != "C1") %>%
  arrange(atlas_block, breeding_category) %>%
  group_by(atlas_block) %>%
  summarise(highest_code = first(breeding_category))

highest_sf <- right_join(blocks_sf, highest, 
                   by = join_by("ID_BLOCK_CODE" == "atlas_block"))

# Plot the spatial data frame
ggplot() +
  geom_sf(data = blocks_sf) +
  geom_sf(data = GAP.summer, aes(fill = present)) + 
  geom_sf(data = highest_sf, aes(fill = highest_code)) + 
  ggtitle("Highest Reported Breeding Code and GAP Summer")
```



# Usage

# Tests

# Speed

# Bugs
present column isn't being renamed appropriately.