---
title: "dev_plot_record_coordinates"
author: "N.M. Tarr"
output: html_document
  html_document:
    df_print: paged
    code_folding: hide
  rmdformats::downcute:
---
```{r setup, include=TRUE, message=TRUE, warning=TRUE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)
```

# Purpose
This document details a function that creates a spatial representation of checklists or observations.
```{r}
records_as_sf_dev <- function(records_df, kind, method) {
  # Create new simple features (spatial data frame) of checklists.  Output can
  #   be plotted, but the primary use will be as input for other functions.
  # 
  #   Description: 
  #   Checklist records often need to be assigned geometries for visualization
  #   and spatial analyses, and different methods could be used.  Checklists
  #   can be represented as points or polygons and polygons could be drawn as 
  #   buffers around the checklist coordinates (circles) or buffers drawn around
  #   checklist tracks.  Buffer length is meant to represent locational
  #   uncertainty and can be approximated in different ways that are currently
  #   supported.  Stationary or short lists should likely be buffered 100 m or
  #   more to account for area surveyed.  Null effort_distance_km
  #   values are filled with zero, which assumes those records are stationary
  #   counts.
  #
  #   Parameters:
  #   records_df -- data frame of records with latitude, longitude, 
  #     checklists_id or sampling_event_identifier, atlas_block, protocol_type,
  #     and effort_distance_km columns.
  #   kind -- "checklists" or "observations" to identify what type of records are
  #     in the data frame.  Individual species data will be observations.
  #   method -- how to represent each record spatially.  Options are "points",
  #     "point-radius", and "buffered-tracks".
  #   
  #   Results:
  #   A spatial (simple features) data frame with columns for checklist_id or 
  #     sampling_event_identifier, atlas_block, protocol_type, 
  #     effort_distance_km, latitude, longitude.
  library(sf)
  
  if (kind == "checklists"){
    records_df <- records_df %>%
      select(checklist_id, atlas_block, protocol_type, effort_distance_km,
             latitude, longitude)
  } else {
    records_df <- records_df %>%
      select(sampling_event_identifier, atlas_block, protocol_type, 
             effort_distance_km, latitude, longitude, observation_count)
  }
  
  # Make spatial frame
  checklists_sf <- records_df %>%
    st_as_sf(coords=c("longitude", "latitude"), crs=4326) %>%
    st_transform(6542)
  
  # Apply method
  if (method == "points") {
    checklists_sf <- checklists_sf %>% select(geometry)
  }
    
  if (method == "point-radius") {
    checklists_sf <- checklists_sf %>%
      # Buffer coordinates
      replace_na(list(effort_distance_km=0)) %>%
      #ilter(effort_distance_km <= 5) %>%
      mutate(buffer_length = (effort_distance_km + 0.1)*1000) %>%
      mutate(footprint = st_buffer(geometry, buffer_length)) %>%
      select(-c(geometry)) %>%
      mutate(geometry = footprint) %>%
      st_set_geometry("geometry")
  }
    
  if (method == "buffer-tracks") {
    print("This method is currently unavailable until we get checklist tracks.")
  }
  
  return(checklists_sf)
}
```


# Usage
This demo requires the tidyverse packages.
```{r}
library(tidyverse)
```

Load the NCBA functions because this function relies upon the output from some of them.
```{r}
setwd("~/Code/NCBA/resources")
source("ncba_functions.R")
config <- "~/Documents/NCBA/Scripts/ncba_config.R"
```

Set the working directory to somewhere outside of the NCBA repository so that results are not saved in the repository.
```{r}
setwd("~/Documents/NCBA/species/")
```

Use the NCBA connection function to connect to the Atlas Cache (the mongodb).
```{r}
# connect to a specific collection (table)
connection <- connect_ncba_db(ncba_config = config, database = "ebd_mgmt", 
                              collection = "ebd")
```

## Species-level records
Identify a species to investigate.
```{r}
species <- "Willow Flycatcher"
```

Retrieve the records for the species from the Atlas Cache
```{r}
time1 <- proc.time()

# execute a query
query <- str_interp('{"OBSERVATIONS.COMMON_NAME":"${species}"}')

nc_data <- connection$find(query) %>%
  unnest(cols = (c(OBSERVATIONS))) %>% # Expand observations
  filter(COMMON_NAME == species)

# format columns to the standard analysis format (ebd format)
records <- to_ebd_format(nc_data, drop=FALSE)

# Calculate processing time
mongotime <- proc.time() - time1

# Print number of records returned
print(paste("Records returned:", nrow(records)))
print(paste("Runtime: ", mongotime[["elapsed"]]))
print(head(records))
```

Plot the coordinates
```{r}
coords.map <- records_as_sf_dev(records, kind = "observations", 
                                method = "points")
plot(coords.map)
```

