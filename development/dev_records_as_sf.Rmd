---
title: "dev_records_as_sf"
author: "N.M. Tarr"
output:
  word_document: default
  html_document: default
---
```{r setup, include=TRUE, message=TRUE, warning=TRUE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)
```

This demo requires the tidyverse packages.
```{r}
library(tidyverse)
```

Load the NCBA functions because this function relies upon the output from some of them.
```{r}
setwd("~/Code/NCBA/resources")
source("ncba_functions.R")
config <- "~/Documents/NCBA/Scripts/ncba_config.R"
```


# Purpose
This document details a function that creates a spatial representation of checklists or observations.  SHOULD A MAX EFFORT DISTANCE PARAMETER BE ADDED?
```{r}
records_as_sf
```


# Usage
Set the working directory to somewhere outside of the NCBA repository so that results are not saved in the repository.
```{r}
setwd("~/Documents/NCBA/species/")
```

Use the NCBA connection function to connect to the Atlas Cache (the mongodb).
```{r}
# connect to a specific collection (table)
connection <- connect_ncba_db(ncba_config = config, database = "ebd_mgmt", 
                              collection = "ebd")
```

ncba_functions has a function that returns a spatial data frame of NC counties in the 6542 CRS.  Get that for use later in maps.
```{r}
counties <- counties_NC()
```


## Observations (species-level records)
Identify a species to investigate.
```{r}
species <- "Virginia Rail"
```

Retrieve the records for the species from the Atlas Cache
```{r}
time1 <- proc.time()

nc_data <- get_observations(species, database = "AtlasCache", NCBA_only = TRUE,
                            EBD_fields_only = TRUE, ncba_config = config)

# format columns to the standard analysis format (ebd format)
records <- to_EBD_format(nc_data, drop=FALSE)

# Calculate processing time
mongotime <- proc.time() - time1

# Print number of records returned
print(paste("Records returned:", nrow(records)))
print(paste("Runtime: ", mongotime[["elapsed"]]))
```

Plot the coordinates
```{r}
coords <- records_as_sf_dev(records, kind="observations", method="points")

# Make a simple map
ggplot(data = counties) +
    geom_sf() +
    geom_sf(data = coords, size = 4, shape = 20, 
            crs = st_crs(6542), colour = "darkred") + 
    ggtitle(paste("All Record Coordinates for the", species), subtitle = "")
```

Plot the footprints.
```{r}
footprints <- records_as_sf_dev(records, kind="observations", 
                              method="point-radius")

# Make a simple map
ggplot(data = counties) +
    geom_sf() +
    geom_sf(data = footprints, size = 4, shape = 20, 
            crs = st_crs(6542), colour = "darkred", fill = NA) + 
    ggtitle(paste("All Record Footprints for the", species), subtitle = "")
```

Preview the result as a data frame
```{r}
print(head(footprints))
```

Plot just the records that confirm breeding
```{r}
# Get our list of confirmation codes from ncba_functions
conf_codes <- breeding_codes()["confirmed"][[1]]

# Select only those records that confirm
confirmed <- records %>% filter(breeding_code %in% conf_codes)

# Make it spatial
confirmed_sf <- records_as_sf_dev(confirmed, kind="observations", 
                                  method="points")

# Make a simple map
ggplot(data = counties) +
    geom_sf() +
    geom_sf(data = confirmed_sf, size = 4, shape = 20, 
            crs = st_crs(6542), colour = "darkred") + 
    ggtitle(paste("Coordinates for Confirmed Breeding by the", species), subtitle = "")
```

## Checklists
Retrieve a dataframe of checklists.  Note that this use depends on connection code from above.
```{r}
checklists <- get_checklists(ncba_config = config) %>% 
  to_EBD_format(drop=TRUE)
```

Plot the coordinates for all of the checklists from the Atlas Cache.
```{r}
# Make the data frame spatial
footprints <- records_as_sf_dev(checklists, kind="checklists", method="points")

# Make a simple map
ggplot(data = counties) +
       geom_sf() +
       geom_sf(data = footprints, size = 4, shape = 3, crs = st_crs(6542),
               colour = "darkred") + 
       ggtitle("All NC Atlas Cache Checklist Coordinates", subtitle = "")
```

