---
title: "dev_block_spp_list"
author: "N.M. Tarr"
date: "2023-10-06"
output: word_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
setwd("~/Code/NCBA/resources")
source("ncba_functions.R")

knitr::opts_knit$set(root.dir = work_dir)
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)
```


# Purpose
This document details and demonstrates a function that retrieves a list of reported species from a particular atlas block.

# Function
```{r}
block_spp_lists <- function(block, start_day = 1, end_day = 365, within = TRUE) {
  # Generates a list of species lists by breeding category for a specified block.
  #
  # Description:
  # ALL observations are pulled from the Atlas Cache for the specified block and 
  #   species lists are generated by breeding category.  Any reported species is
  #   considered "observed" regardless of whether a breeding code was submitted
  #   for the species. Results can be restricted to within a period of the year 
  #   (e.g., season) by using the start_day and end_day arguments to set the 
  #   period bounds.  The start and end days are included in the period.  The 
  #   lists returned include one for all species reported for the category (e.g.,
  #   "possible") and one for only those species for which the category is
  #   is the highest reported (e.g., "possible_highest").
  #
  # Arguments:
  # block -- an atlas block ID code.  Passed to get_observations().
  # start_day -- a numbered day of the year for the start of a period.  Can be 
  #   obtained with yday().
  # end_day -- a numbered day of the year for the end of a period
  # within -- TRUE or FALSE whether to exclude records from outside of the
  #   period.  TRUE keeps records within the period and FALSE keeps records 
  #   from outside of the period. Start and end days are considered part of the 
  #   period (i.e. the process is inclusive for within == TRUE and exclusive for
  #   within == FALSE).
  
  # Get all the observations from the block
  observations <- get_observations(block = block, project = NULL) %>%
    to_EBD_format()
  
  # Filter on day period
  if (within == TRUE) {
    observations <- observations %>%
      filter(yday(observation_date) >= start_day & yday(observation_date) <= end_day)
  }
  
  if (within == FALSE) {
    observations <- observations %>%
      filter(yday(observation_date) < start_day | yday(observation_date) > end_day)
  }
  
  # Get species list from the common name column
  observed_spp <- unique(observations$common_name)
  # Remove ".sp" and "/" names
  observed_spp <- observed_spp[!grepl("sp.", observed_spp)]
  observed_spp <- observed_spp[!grepl("/", observed_spp)]
  
  # Get a list of confirmed species
  confirmed <- filter(observations, breeding_category == "C4")
  confirmed_spp <- unique(confirmed$common_name)
  # Remove ".sp" and "/" names
  confirmed_spp <- confirmed_spp[!grepl("sp.", confirmed_spp)]
  confirmed_spp <- confirmed_spp[!grepl("/", confirmed_spp)]
  
  # Get a list of probable species
  probable <- filter(observations, breeding_category == "C3")
  probable_spp <- unique(probable$common_name)
  # Remove ".sp" and "/" names
  probable_spp <- probable_spp[!grepl("sp.", probable_spp)]
  probable_spp <- probable_spp[!grepl("/", probable_spp)]
  
  # Get a list of possible species
  possible <- filter(observations, breeding_category == "C2")
  possible_spp <- unique(possible$common_name)
  # Remove ".sp" and "/" names
  possible_spp <- possible_spp[!grepl("sp.", possible_spp)]
  possible_spp <- possible_spp[!grepl("/", possible_spp)]
  
  probable_spp_highest <- setdiff(probable_spp, confirmed_spp)
  possible_spp_highest <- setdiff(possible_spp, 
                                  union(confirmed_spp, probable_spp))
  observed_spp_highest <- setdiff(observed_spp, 
                                  union(confirmed_spp, 
                                        union(possible_spp, probable_spp)))

  # Build a list as output
  output <- list("observed" = observed_spp, "possible" = possible_spp,
                 "probable" = probable_spp, "confirmed" = confirmed_spp,
                 "observed_highest" = observed_spp_highest,
                 "possible_highest" = possible_spp_highest,
                 "probable_highest" = probable_spp_highest,
                 "all" = union(observed_spp, union(union(possible_spp, probable_spp),
                                               confirmed_spp)))
  
  return(output)
}
```

# Usage

Get summer species lists for a block of interest (May 15 - August 15).
```{r}
block <- "35078H8SE"
spp_lists <- block_spp_lists(block = block, start_day = 135, end_day = 227,
                             within = TRUE)
```

Combine the lists to get a list of all species reported.
```{r}
summer_spp_observed <- spp_lists$all 
```


Get a list of species predicted to occur.
```{r}
source <- "GAP"
season <- "summer"

season <- str_to_upper(season)
source_lookup <- list("GAP" = "GAP_SPP", "eBird" = "EBD_SPP")
source <- source_lookup[[source]]

# Connect to the blocks collection (table)
connection_blocks <- connect_ncba_db(database = "ebd_mgmt", 
                                     collection = "blocks")

# Define and execute a query (with fields) for blocks of predicted presence.
fields <- str_interp('{"${source}": true}')
query <- str_interp('{"ID_BLOCK_CODE" : "${block}"}')
pres <- connection_blocks$find(query = query, fields = fields) %>%
  unnest(source)

# GAP
if (source == "GAP_SPP") {
  # Summer list
  summer_spp <- pres %>% 
    filter(SUMMER == 1)
  summer_spp <- summer_spp$PRIMARY_COM_NAME
  
  # Winter list
  winter_spp <- pres %>% 
    filter(WINTER == 1)
  winter_spp <- winter_spp$PRIMARY_COM_NAME  
} 

if (source == "EBD_SPP") {
  # Summer list
  summer_spp <- pres %>% 
    filter(BREEDING == 1)
  summer_spp <- summer_spp$PRIMARY_COM_NAME
  
  # Winter list
  winter_spp <- pres %>% 
    filter(WINTERING == 1)
  winter_spp <- winter_spp$PRIMARY_COM_NAME
}
```

Which species were predicted to occur during summer but have not been observed?
```{r}
print(setdiff(summer_spp, spp_lists$all))
```

Which species were not predicted to occur but were then observed?
```{r}
print(setdiff(spp_lists$all, summer_spp))
```


Which species have been observed, but not coded as probable or confirmed during summer?
```{r}
print(setdiff(spp_lists$all, union(spp_lists$probable, spp_lists$confirmed)))
```

Species count table
```{r}
# Make empty data frame
dataframe <- data.frame(
  highest_category = c("observed", "possible", "probable", "confirmed"),
  species_count = c(0, 0, 0, 0),
  percent_observed = c(0, 0, 0, 0),
  percent_predicted = c(0, 0, 0, 0)
)

# Fill out values
dataframe[dataframe$highest_category == "observed", 
          "species_count"] <- length(spp_lists$observed_highest)
dataframe[dataframe$highest_category == "possible", 
          "species_count"] <- length(spp_lists$possible_highest)
dataframe[dataframe$highest_category == "probable", 
          "species_count"] <- length(spp_lists$probable_highest)
dataframe[dataframe$highest_category == "confirmed", 
          "species_count"] <- length(spp_lists$confirmed)

# Get species count for what's been observed
total <- length(spp_lists$all)

dataframe[dataframe$highest_category == "observed", 
          "percent_observed"] <- round(100*(length(spp_lists$observed_highest)/total))
dataframe[dataframe$highest_category == "possible", 
          "percent_observed"] <- round(100*(length(spp_lists$possible_highest)/total))
dataframe[dataframe$highest_category == "probable", 
          "percent_observed"] <- round(100*(length(spp_lists$probable_highest)/total))
dataframe[dataframe$highest_category == "confirmed", 
          "percent_observed"] <- round(100*(length(spp_lists$confirmed)/total))

# Get species count for predicted
total <- length(summer_spp)

dataframe[dataframe$highest_category == "observed", 
          "percent_predicted"] <- round(100*(length(spp_lists$observed_highest)/total))
dataframe[dataframe$highest_category == "possible", 
          "percent_predicted"] <- round(100*(length(spp_lists$possible_highest)/total))
dataframe[dataframe$highest_category == "probable", 
          "percent_predicted"] <- round(100*(length(spp_lists$probable_highest)/total))
dataframe[dataframe$highest_category == "confirmed", 
          "percent_predicted"] <- round(100*(length(spp_lists$confirmed)/total))

print(dataframe)
```



# Tests
```{r}

```


# Speed
Run the function several times to get descriptive statistics.
```{r}
# Run the function 5 times and record the runtime
time <- c()
for (i in 1:5) {
  time1 <- proc.time()
  
  t <- proc.time() - time1
  time[i] <- t["elapsed"]
}

# Print the descriptive statistics
print(summary(time))
```