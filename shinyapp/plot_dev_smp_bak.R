## Development code to adjust species accumulation curve
# S. Pearson, 2023-11-01

library(dplyr)
library(ggplot2)

# pipeline <- "[{\"$match\": {\"ID_NCBA_BLOCK\": \"MARS_HILL-SE\"}},{\"$unwind\": {\"path\": \"$OBSERVATIONS\"}}, {\"$match\": {\"OBSERVATIONS.CATEGORY\": \"species\"}},{\"$group\": {\"_id\": {\"blockName\": \"$ID_NCBA_BLOCK\",\"spp\": \"$OBSERVATIONS.COMMON_NAME\"},\"maxBC\": {\"$max\": \"$OBSERVATIONS.BREEDING_CATEGORY\"}}}]"
# spp_bcs <- aggregate_ebd_data(pipeline)

setwd("C:/Users/spearson/Dropbox/NCBA/code/NCBA/shinyapp")
setwd("C:/Users/72x/Dropbox/NCBA/code/NCBA/shinyapp")

load("block_data_smp.Rdata")	
	# holds "block_recs", "spp_bcs" dataframes for MARS_HILL-SE block

### copied from 'plot_spp_accumulation <- function(block_recs, spp_bcs)'
# function definition in blocks.R

  spp_acc <- data.frame(matrix(ncol=6, nrow=0))
  colnames(spp_acc) <- c('min','all','c1','c2','c3','c4')

  # saving data for code development - SMP
  # save(list=c("block_recs", "spp_bcs"), file="block_data_smp.Rdata")

  #keep track of unique spp and their breeding_categories
  spp_unique <- data.frame(matrix(ncol=3,nrow=0))
  colnames(spp_unique) <- c("spp","bcat","bcat_num")
  obs_min <- 0
  curr_checklist <- "" #placeholder for current SAMPLING_EVENT_IDENTIFIER
  # spp_check_unique <- 0 #checklist unique spp count

  for (i in 1:nrow(block_recs)){
    # check to see if this is a new checklist
      if (curr_checklist != block_recs$SAMPLING_EVENT_IDENTIFIER[i]) {
        # save a new row in the dataset
        #get current category count
        if (i > 1) {
          c1 <- length(spp_unique["spp"][spp_unique["bcat"] == "C1"])
          c2 <- length(spp_unique["spp"][spp_unique["bcat"] == "C2"])
          c3 <- length(spp_unique["spp"][spp_unique["bcat"] == "C3"])
          c4 <- length(spp_unique["spp"][spp_unique["bcat"] == "C4"])
          # print(c(c1,c2,c3,c4))
          # print(c(obs_min,length(spp_unique$spp),c1,c2, c3, c4))
          spp_acc[nrow(spp_acc) + 1, ] <- 
			c(obs_min, length(spp_unique$spp), c1, c2, c3, c4)
        		}	# close if i

        # new checklist, add minutes to total
        obs_min <- obs_min + block_recs$DURATION_MINUTES[i]
        curr_checklist <- block_recs$SAMPLING_EVENT_IDENTIFIER[i]
        	} # close if new checklist

      # set values for spp name and breeding category
      curr_spp <- block_recs$COMMON_NAME[i]
      curr_bcat <- block_recs$BREEDING_CATEGORY[i]
      
      if (curr_bcat == "") { curr_bcat <- "C1" } # "observed" stored as either "" or "C1"

      curr_bcat_num <- strtoi(substr(curr_bcat,2,2))

      # capture ntot counts
      if (!(curr_spp %in% spp_unique$spp)) {	# found a new species!
        spp_unique[nrow(spp_unique)+1,] <- c(curr_spp, curr_bcat, curr_bcat_num)
      						} else {
        # spp already observed in the block, check to see if the bcat is better
        # get current spp row data
        exist_spp_row <- spp_unique[][spp_unique["spp"] == curr_spp]

        # check if bcat is better than previous observation
        if (curr_bcat_num > exist_spp_row[3]) {
          # better bcat
          spp_unique["bcat"][spp_unique["spp"] == curr_spp] <- curr_bcat
          spp_unique["bcat_num"][spp_unique["spp"] == curr_spp] <- curr_bcat_num
        							} # close if

      					} # close if !(curr_spp...end counting breeding codes
  } #end loop


  #add final data point
  c1 <- length(spp_unique["spp"][spp_unique["bcat"] == "C1"])
  c2 <- length(spp_unique["bcat"][spp_unique["bcat"] == "C2"]) # possible
  c3 <- length(spp_unique["bcat"][spp_unique["bcat"] == "C3"]) # probable
  c4 <- length(spp_unique["bcat"][spp_unique["bcat"] == "C4"]) # confirmed

  # print(c(obs_min,length(spp_unique$spp),c1,c2, c3, c4))
  spp_acc[nrow(spp_acc)+1,]<-c(obs_min,length(spp_unique$spp),c1,c2, c3, c4)

  # convert counts in spp_acc to percentages for 
  spp_acc_cnt <- spp_acc	# back up spp_acc
  # spp_acc <- spp_acc_cnt 
  
  # loop across fields c1..c4 converting to percentages
  for (i in 3:6){	spp_acc[,i] <- (spp_acc[,i]/spp_acc$all)*100 }
  spp_acc$c2_4 <- apply(spp_acc[,4:6],1,sum)	# percent spp with codes of C2,C3,C4
  spp_acc[,3:7] <- round(spp_acc[,3:7],0)		# round to integers
  # View(spp_acc)

  spp_tot <- nrow(spp_unique)
  spp_tot_half <- spp_tot * 0.5
  hrs_convert <- 60.0
  hrs_total = obs_min/hrs_convert

  # plot the data
  plot_response <- ggplot(data=spp_acc,aes((min), all)) +
    # geom_hline( aes(yintercept=(spp_tot_half), colour = "50% total")) +
    # geom_text( aes((0.05*max(spp_acc$min)),spp_tot_half),label = "50% total spp", vjust = -1) +
    # geom_smooth( method = 'loess', formula = 'y ~ x', aes(y = all, colour="all")) +
    geom_hline( yintercept=(50),linetype=2) +
    geom_hline( yintercept=(25),linetype=2) +
    geom_smooth(method = 'loess', formula = 'y ~ x',	aes(y = c2_4, color="With Codes")) +
    geom_smooth(method = 'loess', formula = 'y ~ x',	aes(y = c4, color="Confirmed")) +
    geom_smooth(method = 'loess', formula = 'y ~ x',	aes(y = c3, color="Probable")) +
    geom_smooth(method = 'loess', formula = 'y ~ x',	aes(y = c2, color="Possible")) +
    scale_colour_manual( name="Breeding status", # values = c("#ff1a1a", "#ffbf00", "#ccccff")) +
	values = c("#2a3b4d", "#ff1a1a", "#ffbf00", "#ccccff")) +
	# values = c("#444444", "#2a3b4d", "#ff1a1a", "#ffbf00", "#ccccff")) +
    geom_text(aes(0,25),label = "25% goal", vjust=-0.5, hjust=-0.05) +
    xlim(0,obs_min) +
    ylab("Percent of Species") + xlab("Observation Time") 

  plot_response	# show the plot - SMP

  #figure out how to provide multiple return data
  # plot = accumulation plot output
  # spp_uniques = list of species found
  # spp_acc + Number of unique spp found
  response <- list(
    "plot" = plot_response,
    "spp_unique" = spp_unique,
    "spp_acc_data" = spp_acc,
    "hrs_total" = hrs_total)

  return(response)

