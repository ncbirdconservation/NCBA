---
title: "demo_block_stats"
author: "N.M. Tarr"
date: "2023-10-10"
output: word_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
setwd("~/Code/NCBA/resources")
source("ncba_functions.R")
library(auk)

knitr::opts_knit$set(root.dir = work_dir)
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE)
```


# Purpose
This document details and demonstrates code that provides information about the data available for an individual block.  Questions of block status will likely be season-specific, so this demo is organized by season.

First, specify a block of interest.
```{r}
block <- "35079H1SE"
```

Get a list of species predicted by National GAP to occur in the block in each season.
```{r}
preds <- block_predicted_spp(block = block, source = "GAP")
predicted_summer <- preds$summer
predicted_winter <- preds$winter
```


## Summer/Breeding Season
Breeding season dates vary by species, but we need to choose a single start and end date.  Therefore, look at some calculated start and end dates (excluding outliers) for common, early, and late breeders to inform a choice in dates.  The flock of interest is in the Piedmont, so focus on Piedmont dates.

The Northern Cardinal seems to breed as soon as possible given weather and is very common.
```{r}
print(calculate_breeding_dates(species = "Northern Cardinal",
                               basis = c("confirmed", "probable"),
                               quantiles = c(0.05, 0.95),
                               year = 2023,
                               year_day = FALSE))
```

The American Goldfinch is a later breeder.
```{r}
print(calculate_breeding_dates(species = "American Goldfinch",
                               basis = c("confirmed", "probable"),
                               quantiles = c(0.05, 0.95),
                               year = 2023,
                               year_day = FALSE))
```

The Carolina Wren seems to breed several times per year if possible.
```{r}
print(calculate_breeding_dates(species = "Carolina Wren",
                               basis = c("confirmed", "probable"),
                               quantiles = c(0.05, 0.95),
                               year = 2023,
                               year_day = FALSE))
```

Based on the results of the breeding date calculations, it seems that March 11 - August 18 is a good choice for the Piedmont.  Get species lists from the Atlas Cache for the time period between those days.
```{r}
start_day <- 70
end_day <- 230
observed_summer <- block_spp_lists(block = block, start_day = start_day, 
                                   end_day = end_day, within = TRUE)
```

Which species were predicted to occur during summer but have not been observed?
```{r}
print(setdiff(predicted_summer, observed_summer$all))
```

Which species were not predicted to occur but were then observed?
```{r}
print(setdiff(observed_summer$all, predicted_summer))
```

Which species have been observed, but not coded as probable or confirmed during summer?
```{r}
print(setdiff(observed_summer$all, union(observed_summer$probable, observed_summer$confirmed)))
```

Get a summary of how many species have been submitted for each breeding category.
```{r}
print(spp_count_summary(observed_summer, predicted_summer))
```


```{r}
summarize_duration <- function(summarize_by, start_day, end_day, within) {
  
  # Get all the checklists from the block
  fields <- c("checklist_id", "year", "month", "ncba_nocturnal", "duration_minutes",
              "observation_date", "atlas_block", "sampling_event_identifier")
  
  checklists <- get_checklists(block = block, EBD_fields_only = FALSE) %>%  ### PROBLEN WHEN THIS IS NULL
    to_EBD_format() %>%
    auk_unique(checklists_only = TRUE)
  
  if (within == TRUE) {
    # Filter within period
    checklists <- checklists %>%
        filter(yday(observation_date) >= start_day & yday(observation_date) <= end_day)
  } 
  
  if (within == FALSE) {
    # Filter outside period
    checklists.W <- checklists %>%
        filter(yday(observation_date) < start_day | yday(observation_date) > end_day)
  }
  
  if (summarize_by == "year") {
    # Summarize
    summary <- checklists %>%
      select(c("year", "ncba_nocturnal", "duration_minutes")) %>%
      group_by(year, ncba_nocturnal) %>%
      summarize(total_hrs = sum(duration_minutes)/60) %>%
      pivot_wider(names_from = ncba_nocturnal, values_from = total_hrs) %>%
      replace_na(list("1" = 0)) %>%
      mutate_if(is.numeric, ~round(., 1))
    
    # Rename columns 
    names(summary) <- c("year", "diurnal_hours", "nocturnal_hours")
  }
  
  if (summarize_by == "month") {
    # Summarize
    summary <- checklists %>%
      select(c("month", "ncba_nocturnal", "duration_minutes")) %>%
      group_by(month, ncba_nocturnal) %>%
      summarize(total_hrs = sum(duration_minutes)/60) %>%
      pivot_wider(names_from = ncba_nocturnal, values_from = total_hrs) %>%
      replace_na(list("1" = 0)) %>%
      mutate_if(is.numeric, ~round(., 1))
    
    # Replace month number with abb
    summary$month <- month.abb[summary$month]
    
    # Rename columns 
    names(summary) <- c("month", "diurnal_hours", "nocturnal_hours")
  }
    
  if (summarize_by == "year-month") {
    # Summarize
    summary <- checklists %>%
      select(c("year", "month", "ncba_nocturnal", "duration_minutes")) %>%
      group_by(year, month, ncba_nocturnal) %>%
      summarize(total_hrs = sum(duration_minutes)/60) %>%
      pivot_wider(names_from = ncba_nocturnal, values_from = total_hrs) %>%
      replace_na(list("1" = 0)) %>%
      mutate_if(is.numeric, ~round(., 1))
    
    # Replace month number with abb
    summary$month <- month.abb[summary$month]
    
    # Rename columns 
    names(summary) <- c("year", "month", "diurnal_hours", "nocturnal_hours")
  }
  
  return(summary)
}

print(summarize_duration(summarize_by = "year", start_day = start_day,
                         end_day = end_day, within = TRUE))
```

## Winter
Assign start and end days to for winter.  The concept of winter regarding birds is more ambiguous than summer, so use the NCBA winter start and end days.
```{r}
start_day <- 59
end_day <- 305
```





